package com.arogyasakhi.service;

import com.arogyasakhi.model.UserProfile;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;
import reactor.core.publisher.Mono;

import java.time.Duration;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
public class GeminiService {
    
    @Value("${gemini.api.key}")
    private String apiKey;
    
    @Value("${gemini.api.url}")
    private String apiUrl;
    
    private final WebClient webClient;
    private final ObjectMapper objectMapper;
    
    public GeminiService() {
        this.webClient = WebClient.builder()
                .codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(2 * 1024 * 1024))
                .build();
        this.objectMapper = new ObjectMapper();
    }
    
    public String getHealthRecommendation(String symptoms, UserProfile userProfile, String language) {
        try {
            System.out.println("üîç Starting health recommendation...");
            System.out.println("üîë API Key present: " + (apiKey != null && !apiKey.isEmpty()));
            System.out.println("üåê API URL: " + apiUrl);
            System.out.println("üìù Symptoms: " + symptoms);
            System.out.println("üó£Ô∏è Language: " + language);
            
            // Validate inputs
            if (apiKey == null || apiKey.trim().isEmpty()) {
                System.err.println("‚ùå Gemini API key is missing!");
                return getErrorMessage(language, "API key not configured");
            }
            
            if (symptoms == null || symptoms.trim().isEmpty()) {
                return getErrorMessage(language, "No symptoms provided");
            }
            
            String prompt = buildDetailedHealthPrompt(symptoms, userProfile, language);
            System.out.println("üìù Prompt length: " + prompt.length());
            
            Map<String, Object> requestBody = buildRequestBody(prompt);
            
            // Log the request body for debugging
            String requestJson = objectMapper.writeValueAsString(requestBody);
            System.out.println("üì§ Request JSON length: " + requestJson.length());
            
            String fullUrl = apiUrl + "?key=" + apiKey;
            
            Mono<String> responseMono = webClient.post()
                    .uri(fullUrl)
                    .header("Content-Type", "application/json")
                    .header("User-Agent", "Arogya-Sakhi-Bot/1.0")
                    .bodyValue(requestBody)
                    .retrieve()
                    .bodyToMono(String.class)
                    .timeout(Duration.ofSeconds(30));
            
            String responseBody = responseMono.block();
            System.out.println("üì• Response received, length: " + (responseBody != null ? responseBody.length() : 0));
            
            String recommendation = parseGeminiResponse(responseBody);
            System.out.println("‚úÖ Health recommendation generated successfully");
            
            return recommendation;
            
        } catch (WebClientResponseException e) {
            System.err.println("‚ùå Gemini API Error:");
            System.err.println("   Status: " + e.getStatusCode());
            System.err.println("   Response: " + e.getResponseBodyAsString());
            
            // Try to parse error response
            try {
                JsonNode errorResponse = objectMapper.readTree(e.getResponseBodyAsString());
                if (errorResponse.has("error")) {
                    JsonNode error = errorResponse.get("error");
                    String errorMessage = error.has("message") ? error.get("message").asText() : "Unknown error";
                    System.err.println("   Error message: " + errorMessage);
                    return getErrorMessage(language, "API Error: " + errorMessage);
                }
            } catch (Exception parseError) {
                System.err.println("   Could not parse error response: " + parseError.getMessage());
            }
            
            return getErrorMessage(language, "API Error: " + e.getStatusCode());
            
        } catch (Exception e) {
            System.err.println("‚ùå Unexpected error in health recommendation: " + e.getMessage());
            e.printStackTrace();
            return getErrorMessage(language, "Unexpected error: " + e.getMessage());
        }
    }
    
    private Map<String, Object> buildRequestBody(String prompt) {
        Map<String, Object> requestBody = new HashMap<>();
        
        // Contents array
        Map<String, Object> content = new HashMap<>();
        Map<String, Object> part = new HashMap<>();
        part.put("text", prompt);
        content.put("parts", List.of(part));
        requestBody.put("contents", List.of(content));
        
        // Generation config for better medical responses
        Map<String, Object> generationConfig = new HashMap<>();
        generationConfig.put("temperature", 0.3); // Lower temperature for more consistent medical advice
        generationConfig.put("topK", 40);
        generationConfig.put("topP", 0.95);
        generationConfig.put("maxOutputTokens", 500);
        requestBody.put("generationConfig", generationConfig);
        
        return requestBody;
    }
    
    private String buildDetailedHealthPrompt(String symptoms, UserProfile userProfile, String language) {
        StringBuilder prompt = new StringBuilder();
        
        if ("hi".equals(language)) {
            prompt.append("‡§Ü‡§™ ‡§è‡§ï ‡§Ö‡§®‡•Å‡§≠‡§µ‡•Ä ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§π‡•à‡§Ç‡•§ ‡§Æ‡§∞‡•Ä‡§ú ‡§ï‡•á ‡§≤‡§ï‡•ç‡§∑‡§£‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§∏‡§≤‡§æ‡§π ‡§¶‡•á‡§Ç‡•§\n\n");
            
            // Add patient information
            if (userProfile != null && userProfile.getAge() != null) {
                prompt.append("‡§Æ‡§∞‡•Ä‡§ú ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä:\n");
                prompt.append("- ‡§â‡§Æ‡•ç‡§∞: ").append(userProfile.getAge()).append(" ‡§∏‡§æ‡§≤\n");
                if (userProfile.getGender() != null) {
                    prompt.append("- ‡§≤‡§ø‡§Ç‡§ó: ").append(userProfile.getGender()).append("\n");
                }
                if (userProfile.getWeight() != null && userProfile.getHeight() != null) {
                    prompt.append("- BMI: ").append(String.format("%.1f", userProfile.getBMI())).append("\n");
                }
                if (userProfile.getAllergies() != null && !userProfile.getAllergies().isEmpty()) {
                    prompt.append("- ‡§è‡§≤‡§∞‡•ç‡§ú‡•Ä: ").append(String.join(", ", userProfile.getAllergies())).append("\n");
                }
                if (userProfile.getCurrentMedications() != null && !userProfile.getCurrentMedications().isEmpty()) {
                    prompt.append("- ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§¶‡§µ‡§æ‡§è‡§Ç: ").append(String.join(", ", userProfile.getCurrentMedications())).append("\n");
                }
                prompt.append("\n");
            }
            
            prompt.append("‡§≤‡§ï‡•ç‡§∑‡§£: ").append(symptoms).append("\n\n");
            prompt.append("‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§∏‡§≤‡§æ‡§π ‡§¶‡•á‡§Ç:\n\n");
            prompt.append("üîç ‡§ó‡§Ç‡§≠‡•Ä‡§∞‡§§‡§æ ‡§ï‡§æ ‡§∏‡•ç‡§§‡§∞: (‡§ï‡§Æ/‡§Æ‡§ß‡•ç‡§Ø‡§Æ/‡§â‡§ö‡•ç‡§ö/‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤)\n\n");
            prompt.append("üè† ‡§ò‡§∞‡•á‡§≤‡•Ç ‡§â‡§™‡§ö‡§æ‡§∞:\n");
            prompt.append("- ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§∞‡§æ‡§π‡§§ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§∞‡•á‡§Ç\n");
            prompt.append("- ‡§™‡•ç‡§∞‡§æ‡§ï‡•É‡§§‡§ø‡§ï ‡§â‡§™‡§ö‡§æ‡§∞\n");
            prompt.append("- ‡§Ü‡§π‡§æ‡§∞ ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡•Ä ‡§∏‡•Å‡§ù‡§æ‡§µ\n");
            prompt.append("- ‡§ú‡•Ä‡§µ‡§®‡§∂‡•à‡§≤‡•Ä ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡§æ‡§µ\n\n");
            prompt.append("üíä ‡§¶‡§µ‡§æ ‡§∏‡•Å‡§ù‡§æ‡§µ (‡§¨‡§ø‡§®‡§æ ‡§™‡§∞‡•ç‡§ö‡•á ‡§µ‡§æ‡§≤‡•Ä):\n");
            prompt.append("- ‡§¶‡§∞‡•ç‡§¶ ‡§®‡§ø‡§µ‡§æ‡§∞‡§ï ‡§¶‡§µ‡§æ‡§è‡§Ç\n");
            prompt.append("- ‡§ñ‡•Å‡§∞‡§æ‡§ï ‡§î‡§∞ ‡§∏‡§Æ‡§Ø\n");
            prompt.append("- ‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡§ø‡§Ø‡§æ‡§Ç\n\n");
            prompt.append("‚ö†Ô∏è ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä ‡§∏‡§Ç‡§ï‡•á‡§§:\n");
            prompt.append("- ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§Æ‡§ø‡§≤‡•á‡§Ç ‡§Ø‡§¶‡§ø\n");
            prompt.append("- ‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§Ø‡§æ‡§Ç\n\n");
            prompt.append("üìû ‡§ï‡§¨ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç:\n");
            prompt.append("- ‡§≤‡§ï‡•ç‡§∑‡§£ ‡§¨‡§ø‡§ó‡§°‡§º‡§®‡•á ‡§™‡§∞\n");
            prompt.append("- ‡§ï‡§ø‡§§‡§®‡•á ‡§¶‡§ø‡§® ‡§¨‡§æ‡§¶\n\n");
            prompt.append("‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£: ‡§Ø‡§π ‡§ï‡•á‡§µ‡§≤ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∏‡§≤‡§æ‡§π ‡§π‡•à‡•§ ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§ï ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§");
            
        } else {
            prompt.append("You are an experienced doctor. Provide detailed medical advice for the patient's symptoms.\n\n");
            
            // Add patient information
            if (userProfile != null && userProfile.getAge() != null) {
                prompt.append("Patient Information:\n");
                prompt.append("- Age: ").append(userProfile.getAge()).append(" years\n");
                if (userProfile.getGender() != null) {
                    prompt.append("- Gender: ").append(userProfile.getGender()).append("\n");
                }
                if (userProfile.getWeight() != null && userProfile.getHeight() != null) {
                    prompt.append("- BMI: ").append(String.format("%.1f", userProfile.getBMI())).append("\n");
                }
                if (userProfile.getAllergies() != null && !userProfile.getAllergies().isEmpty()) {
                    prompt.append("- Allergies: ").append(String.join(", ", userProfile.getAllergies())).append("\n");
                }
                if (userProfile.getCurrentMedications() != null && !userProfile.getCurrentMedications().isEmpty()) {
                    prompt.append("- Current Medications: ").append(String.join(", ", userProfile.getCurrentMedications())).append("\n");
                }
                prompt.append("\n");
            }
            
            prompt.append("Symptoms: ").append(symptoms).append("\n\n");
            prompt.append("Please provide detailed advice in the following format:\n\n");
            prompt.append("üîç SEVERITY LEVEL: (Low/Moderate/High/Emergency)\n\n");
            prompt.append("üè† HOME REMEDIES:\n");
            prompt.append("- Immediate relief measures\n");
            prompt.append("- Natural treatments\n");
            prompt.append("- Dietary recommendations\n");
            prompt.append("- Lifestyle modifications\n\n");
            prompt.append("üíä MEDICATION SUGGESTIONS (Over-the-counter):\n");
            prompt.append("- Pain relievers/fever reducers\n");
            prompt.append("- Dosage and timing\n");
            prompt.append("- Precautions and contraindications\n\n");
            prompt.append("‚ö†Ô∏è WARNING SIGNS:\n");
            prompt.append("- When to seek immediate medical attention\n");
            prompt.append("- Emergency symptoms to watch for\n\n");
            prompt.append("üìû WHEN TO CONSULT A DOCTOR:\n");
            prompt.append("- If symptoms worsen\n");
            prompt.append("- Timeline for medical consultation\n\n");
            prompt.append("IMPORTANT: This is general medical advice only. Seek immediate professional medical care for serious conditions.");
        }
        
        return prompt.toString();
    }
    
    private String parseGeminiResponse(String responseBody) {
        try {
            if (responseBody == null || responseBody.trim().isEmpty()) {
                System.err.println("‚ùå Empty response from Gemini API");
                return "No response received from AI service.";
            }
            
            JsonNode root = objectMapper.readTree(responseBody);
            
            // Check for error in response
            if (root.has("error")) {
                JsonNode error = root.get("error");
                String errorMessage = error.has("message") ? error.get("message").asText() : "Unknown API error";
                System.err.println("‚ùå Gemini API returned error: " + errorMessage);
                return "AI service error: " + errorMessage;
            }
            
            // Parse successful response
            JsonNode candidates = root.get("candidates");
            if (candidates != null && candidates.isArray() && candidates.size() > 0) {
                JsonNode firstCandidate = candidates.get(0);
                
                // Check finish reason
                if (firstCandidate.has("finishReason")) {
                    String finishReason = firstCandidate.get("finishReason").asText();
                    System.out.println("üìã Finish reason: " + finishReason);
                    
                    if ("SAFETY".equals(finishReason)) {
                        return "Response was blocked due to safety filters. Please rephrase your symptoms or consult a healthcare professional directly.";
                    }
                }
                
                JsonNode content = firstCandidate.get("content");
                if (content != null && content.has("parts")) {
                    JsonNode parts = content.get("parts");
                    if (parts.isArray() && parts.size() > 0) {
                        JsonNode firstPart = parts.get(0);
                        if (firstPart.has("text")) {
                            String text = firstPart.get("text").asText();
                            if (text != null && !text.trim().isEmpty()) {
                                System.out.println("‚úÖ Successfully parsed response");
                                // Format the response for better readability
                                String formattedText = formatResponseText(text.trim());
                                return formattedText;
                            }
                        }
                    }
                }
            }
            
            System.err.println("‚ùå Could not find valid content in response");
            System.err.println("Response structure: " + root.toString());
            return "Unable to process the AI response. Please try again.";
            
        } catch (Exception e) {
            System.err.println("‚ùå Error parsing Gemini response: " + e.getMessage());
            e.printStackTrace();
            return "Error processing AI response: " + e.getMessage();
        }
    }
    
    private String getErrorMessage(String language, String error) {
        if ("hi".equals(language)) {
            return "‡§Æ‡•Å‡§ù‡•á ‡§§‡§ï‡§®‡•Ä‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§≤‡§ï‡•ç‡§∑‡§£‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§\n\n" +
                   "‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§®‡§Ç‡§¨‡§∞: 108\n" +
                   "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + error;
        } else {
            return "I'm experiencing technical difficulties. Please try again later or consult a healthcare professional for serious symptoms.\n\n" +
                   "Emergency number: 108\n" +
                   "Error: " + error;
        }
    }

    private String formatResponseText(String text) {
        // Remove excessive asterisks and format properly
        String formatted = text
                // Replace **text** with bold formatting for Telegram
                .replaceAll("\\*\\*([^*]+)\\*\\*", "*$1*")
                // Replace single asterisks with bullet points
                .replaceAll("(?m)^\\s*\\*\\s*", "‚Ä¢ ")
                // Clean up multiple asterisks
                .replaceAll("\\*{3,}", "")
                // Format section headers
                .replaceAll("(?i)üîç\\s*SEVERITY LEVEL:", "\nüîç *SEVERITY LEVEL:*")
                .replaceAll("(?i)üè†\\s*HOME REMEDIES:", "\nüè† *HOME REMEDIES:*")
                .replaceAll("(?i)üíä\\s*MEDICATION SUGGESTIONS:", "\nüíä *MEDICATION SUGGESTIONS:*")
                .replaceAll("(?i)‚ö†Ô∏è\\s*WARNING SIGNS:", "\n‚ö†Ô∏è *WARNING SIGNS:*")
                .replaceAll("(?i)üìû\\s*WHEN TO CONSULT:", "\nüìû *WHEN TO CONSULT A DOCTOR:*")
                .replaceAll("(?i)IMPORTANT:", "\n‚ö†Ô∏è *IMPORTANT:*")
                // Format Hindi headers
                .replaceAll("(?i)üîç\\s*‡§ó‡§Ç‡§≠‡•Ä‡§∞‡§§‡§æ ‡§ï‡§æ ‡§∏‡•ç‡§§‡§∞:", "\nüîç *‡§ó‡§Ç‡§≠‡•Ä‡§∞‡§§‡§æ ‡§ï‡§æ ‡§∏‡•ç‡§§‡§∞:*")
                .replaceAll("(?i)üè†\\s*‡§ò‡§∞‡•á‡§≤‡•Ç ‡§â‡§™‡§ö‡§æ‡§∞:", "\nüè† *‡§ò‡§∞‡•á‡§≤‡•Ç ‡§â‡§™‡§ö‡§æ‡§∞:*")
                .replaceAll("(?i)üíä\\s*‡§¶‡§µ‡§æ ‡§∏‡•Å‡§ù‡§æ‡§µ:", "\nüíä *‡§¶‡§µ‡§æ ‡§∏‡•Å‡§ù‡§æ‡§µ:*")
                .replaceAll("(?i)‚ö†Ô∏è\\s*‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä ‡§∏‡§Ç‡§ï‡•á‡§§:", "\n‚ö†Ô∏è *‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä ‡§∏‡§Ç‡§ï‡•á‡§§:*")
                .replaceAll("(?i)üìû\\s*‡§ï‡§¨ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç:", "\nüìû *‡§ï‡§¨ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç:*")
                .replaceAll("(?i)‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£:", "\n‚ö†Ô∏è *‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£:*")
                // Clean up extra newlines
                .replaceAll("\n{3,}", "\n\n")
                // Ensure proper spacing after emojis
                .replaceAll("([üîçüè†üíä‚ö†Ô∏èüìû])([^\\s])", "$1 $2");
        
        return formatted.trim();
    }
}
